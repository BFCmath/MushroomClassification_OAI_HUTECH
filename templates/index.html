<!DOCTYPE html>
<html>
<head>
    <title>Image Filter</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .filter-container { margin-bottom: 20px; }
        
        /* Adjusted grid for bigger images */
        .image-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 15px; 
        }
        
        .image-card { 
            border: 1px solid #ddd; 
            padding: 12px; 
            border-radius: 5px; 
            transition: transform 0.2s ease;
            cursor: pointer;
        }
        
        .image-card:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .image-container { 
            width: 128px;
            height: 128px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 0 auto 15px; 
            background-color: #f8f8f8;
            border: 1px solid #eee;
            border-radius: 3px;
        }
        
        /* CSS for crisp pixel rendering when scaled */
        .image-container img { 
            width: 128px;
            height: 128px;
            image-rendering: pixelated;              /* Chrome, Edge, Safari */
            image-rendering: -moz-crisp-edges;       /* Firefox */
            image-rendering: crisp-edges;            /* Standard */
            object-fit: contain;                     /* Allow image to scale up properly */
        }
        
        .image-id { font-weight: bold; margin: 5px 0; }
        .image-info { font-size: 0.8em; margin: 2px 0; }
        
        /* Modal for zoomed view */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            max-width: 90%;
        }
        
        .modal-image {
            width: 512px;
            height: 512px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            object-fit: contain;                     /* Allow image to scale up properly */
            margin-bottom: 20px;
            border: 2px solid #eee;
            background-color: #f9f9f9;
        }
        
        .close-modal {
            margin-top: 15px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        /* Other styles */
        .active { font-weight: bold; }
        .category-section { margin-top: 30px; }
        .category-title { background-color: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        h3 { margin-top: 20px; }
        .filter-section { margin-bottom: 30px; padding: 15px; background-color: #f8f8f8; border-radius: 5px; }
        .category-nav { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .category-nav a { padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; text-decoration: none; color: #333; }
        .category-nav a.active { background-color: #ddd; }
        
        /* Classification styles */
        .classification-controls {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        
        .classification-input {
            padding: 8px;
            width: 60%;
            margin-right: 10px;
        }
        
        .save-classification {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .save-classification:hover {
            background-color: #45a049;
        }
        
        .export-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-top: 20px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .export-button:hover {
            background-color: #0b7dda;
        }
        
        .classified-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #4CAF50;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        
        .status-success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        
        .status-error {
            background-color: #f2dede;
            color: #a94442;
        }
        
        /* Floating classification panel */
        .class-panel {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 250px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            z-index: 90;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .toggle-panel {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
        }
        
        .class-list {
            margin-bottom: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .class-item {
            padding: 8px;
            margin: 5px 0;
            background-color: #f8f8f8;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .class-item span {
            flex-grow: 1;
        }
        
        .remove-class {
            color: #d9534f;
            cursor: pointer;
            padding: 0 5px;
        }
        
        .add-class-form {
            margin-top: 15px;
        }
        
        .add-class-input {
            width: 70%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .add-class-btn {
            padding: 8px;
            background-color: #5bc0de;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* Adjust modal for class selection */
        .class-select {
            padding: 10px;
            width: 70%;
            margin-right: 10px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* Inline classification dropdown */
        .image-classification {
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .inline-class-select {
            padding: 3px;
            font-size: 0.9em;
            border-radius: 3px;
            border: 1px solid #ddd;
            flex-grow: 1;
        }
        
        .save-load-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #f3f3f3;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .action-button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: white;
        }
        
        .save-button {
            background-color: #4CAF50;
        }
        
        .load-button {
            background-color: #2196F3;
        }
        
        .file-upload {
            display: none;
        }
        
        .file-upload-label {
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Image Filter</h1>
    
    <div class="filter-section">
        <h3>Filter by Type:</h3>
        <div class="filter-container">
            <a href="{{ url_for('index') }}" {% if selected_type is none and selected_category is none %}class="active"{% endif %}>All</a> |
            {% for type in types %}
                <a href="{{ url_for('index', type=type) }}" {% if selected_type == type %}class="active"{% endif %}>Type {{ type }}</a> {% if not loop.last %}|{% endif %}
            {% endfor %}
        </div>
        
        <h3>Filter by Category:</h3>
        <div class="category-nav">
            {% for category in categories %}
                <a href="{{ url_for('index', category=category) }}" {% if selected_category == category %}class="active"{% endif %}>{{ category }}</a>
            {% endfor %}
        </div>
        
        <div style="margin-top: 20px; text-align: right;">
            <a href="{{ url_for('export_classifications') }}" class="export-button">Export Classifications</a>
        </div>
        
        <!-- Save/Load functionality -->
        <div class="save-load-container">
            <div>
                <button onclick="downloadClassifications()" class="action-button save-button">Download Classifications</button>
                <span id="downloadStatus"></span>
            </div>
            <div>
                <input type="file" id="fileUpload" class="file-upload" accept=".txt">
                <label for="fileUpload" class="file-upload-label">Upload Classifications</label>
                <span id="uploadStatus"></span>
            </div>
        </div>
    </div>
    
    <!-- Display by categories -->
    <div id="category-view">
        {% for category, images_in_category in category_images.items() %}
            {% if selected_category is none or selected_category == category %}
                <div class="category-section">
                    <h2 class="category-title">{{ category }}</h2>
                    <div class="image-grid">
                        {% for img in images_in_category %}
                            <div class="image-card" onclick="openModal('{{ url_for('serve_image', filename=img.path) }}', '{{ img.id }}', '{{ img.filename }}', '{{ category }}')">
                                <div class="image-container">
                                    <img src="{{ url_for('serve_image', filename=img.path) }}" alt="{{ img.filename }}">
                                </div>
                                <p class="image-id">
                                    ID: {{ img.id }}
                                    <span id="indicator-{{ img.id }}" class="classified-indicator" style="display: none;"></span>
                                </p>
                                
                                <!-- Inline classification dropdown -->
                                <div class="image-classification" onclick="event.stopPropagation();">
                                    <select id="inline-select-{{ img.id }}" class="inline-class-select" 
                                            onchange="quickClassify('{{ img.id }}')">
                                        <!-- Options will be added dynamically -->
                                    </select>
                                </div>
                                
                                <!-- Match with CSV data if available -->
                                {% for data_img in images %}
                                    {% if data_img.id == img.id %}
                                        <p class="image-info">Type: {{ data_img.type }}</p>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
    
    <!-- Floating Classification Panel -->
    <div id="classPanel" class="class-panel">
        <div class="class-header">
            <h3 style="margin: 0;">Classes</h3>
            <div class="toggle-panel" onclick="togglePanel()">-</div>
        </div>
        <div id="panelContent">
            <div class="class-list" id="classList">
                <!-- Class items will be added here -->
            </div>
            
            <div class="add-class-form">
                <input type="text" id="newClassInput" class="add-class-input" placeholder="New class name">
                <button onclick="addClass()" class="add-class-btn">Add</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for zoomed image view with classification -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <img id="modalImage" class="modal-image" src="" alt="Zoomed Image">
            <div id="modalInfo"></div>
            
            <!-- Classification controls with dropdown -->
            <div class="classification-controls">
                <h3>Classification</h3>
                <div>
                    <select id="classificationSelect" class="class-select">
                        <!-- Options will be added dynamically -->
                    </select>
                    <button onclick="saveClassification()" class="save-classification">Save</button>
                </div>
                <div id="classificationStatus"></div>
            </div>
            
            <button class="close-modal" onclick="closeModal()">Close</button>
        </div>
    </div>
    
    <!-- Show a message if no images are found -->
    {% if categories|length == 0 %}
        <div class="category-section">
            <p>No image categories found in the train directory. Please make sure the train folder exists and contains subfolders with images.</p>
        </div>
    {% endif %}
    
    <script>
        // Store classifications in memory
        let classifications = {};
        let currentImageId = null;
        let availableClasses = ["0"]; // Default class
        
        // Load existing classifications and classes if available
        {% if classifications %}
            classifications = {{ classifications|tojson }};
        {% endif %}
        
        {% if available_classes %}
            availableClasses = {{ available_classes|tojson }};
        {% endif %}
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            updateClassList();
            updateInlineClassSelects();
            updateClassificationIndicators();
            
            // Set up file upload handler
            document.getElementById('fileUpload').addEventListener('change', uploadClassifications);
        });
        
        // Class panel functions
        function togglePanel() {
            const panel = document.getElementById('classPanel');
            const content = document.getElementById('panelContent');
            const toggle = panel.querySelector('.toggle-panel');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '-';
            } else {
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }
        
        function updateClassList() {
            const list = document.getElementById('classList');
            list.innerHTML = '';
            
            availableClasses.forEach(className => {
                const item = document.createElement('div');
                item.className = 'class-item';
                
                const span = document.createElement('span');
                span.textContent = className;
                item.appendChild(span);
                
                // Don't allow removing class 0
                if (className !== "0") {
                    const remove = document.createElement('div');
                    remove.className = 'remove-class';
                    remove.textContent = '×';
                    remove.onclick = function() { removeClass(className); };
                    item.appendChild(remove);
                }
                
                list.appendChild(item);
            });
            
            // Update all select dropdowns
            updateClassSelectOptions();
            
            // Save to server
            saveClassesToServer();
            
            // Also update all inline select dropdowns
            updateInlineClassSelects();
        }
        
        function addClass() {
            const input = document.getElementById('newClassInput');
            const className = input.value.trim();
            
            if (className && !availableClasses.includes(className)) {
                availableClasses.push(className);
                input.value = '';
                updateClassList();
            }
        }
        
        function removeClass(className) {
            availableClasses = availableClasses.filter(c => c !== className);
            
            // Update any images classified with this class back to default
            for (const id in classifications) {
                if (classifications[id] === className) {
                    classifications[id] = "0";
                }
            }
            
            updateClassList();
            updateClassificationIndicators();
            saveToServer();
        }
        
        function saveClassesToServer() {
            fetch('/save_classes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(availableClasses)
            })
            .then(response => response.json())
            .catch(error => {
                console.error('Error saving classes:', error);
            });
        }
        
        function updateClassSelectOptions() {
            const select = document.getElementById('classificationSelect');
            if (select) {
                // Save current selection if exists
                const currentValue = select.value;
                
                // Clear and repopulate
                select.innerHTML = '';
                
                availableClasses.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    select.appendChild(option);
                });
                
                // Restore selection if it still exists
                if (availableClasses.includes(currentValue)) {
                    select.value = currentValue;
                }
            }
        }
        
        // Function to update all inline class select dropdowns
        function updateInlineClassSelects() {
            document.querySelectorAll('[id^="inline-select-"]').forEach(select => {
                // Extract ID from the select element
                const imageId = select.id.replace('inline-select-', '');
                
                // Clear existing options
                select.innerHTML = '';
                
                // Add all available classes
                availableClasses.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    select.appendChild(option);
                });
                
                // Set current classification if exists, otherwise default to "0"
                select.value = classifications[imageId] || "0";
            });
        }
        
        // Quick classify function for inline dropdowns
        function quickClassify(imageId) {
            const select = document.getElementById(`inline-select-${imageId}`);
            if (select) {
                const newClass = select.value;
                classifications[imageId] = newClass;
                
                // Update indicators
                updateClassificationIndicators();
                
                // Save to server
                saveToServer();
            }
        }
        
        // Modal functionality
        function openModal(imageSrc, imageId, filename, category) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalInfo = document.getElementById('modalInfo');
            const classSelect = document.getElementById('classificationSelect');
            
            // Store current image ID
            currentImageId = imageId;
            
            // Set size explicitly to maintain crisp rendering at large sizes
            modalImg.width = 512;
            modalImg.height = 512;
            modalImg.src = imageSrc;
            modalInfo.innerHTML = `
                <h3>Image Details</h3>
                <p><strong>ID:</strong> ${imageId}</p>
                <p><strong>Filename:</strong> ${filename}</p>
                <p><strong>Category:</strong> ${category}</p>
            `;
            
            // Get type info if available
            {% for data_img in images %}
                if ("{{ data_img.id }}" === imageId) {
                    modalInfo.innerHTML += `<p><strong>Type:</strong> {{ data_img.type }}</p>`;
                }
            {% endfor %}
            
            // Update class select options
            updateClassSelectOptions();
            
            // Set existing classification if available, otherwise default to "0"
            classSelect.value = classifications[imageId] || "0";
            
            modal.style.display = "flex";
        }
        
        function saveClassification() {
            const newClass = document.getElementById('classificationSelect').value;
            const statusDiv = document.getElementById('classificationStatus');
            
            if (currentImageId) {
                classifications[currentImageId] = newClass;
                statusDiv.innerHTML = '<div class="status-message status-success">Classification saved!</div>';
                
                // Update indicators
                updateClassificationIndicators();
                
                // Save to server
                saveToServer();
            } else {
                statusDiv.innerHTML = '<div class="status-message status-error">No image selected!</div>';
            }
        }
        
        function closeModal() {
            document.getElementById('imageModal').style.display = "none";
            document.getElementById('classificationStatus').innerHTML = '';
        }
        
        function updateClassificationIndicators() {
            // Hide all indicators first
            document.querySelectorAll('.classified-indicator').forEach(indicator => {
                indicator.style.display = 'none';
            });
            
            // Show indicators for classified images
            for (const imageId in classifications) {
                const indicator = document.getElementById(`indicator-${imageId}`);
                if (indicator) {
                    indicator.style.display = 'inline-block';
                }
            }
        }
        
        function saveToServer() {
            fetch('/save_classifications', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(classifications)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    console.error('Error saving classifications:', data.message);
                }
            })
            .catch(error => {
                console.error('Error saving classifications:', error);
            });
        }
        
        // Download classifications
        function downloadClassifications() {
            const statusDiv = document.getElementById('downloadStatus');
            statusDiv.textContent = 'Preparing download...';
            
            window.location.href = "{{ url_for('export_classifications') }}";
            
            setTimeout(() => {
                statusDiv.textContent = 'Download complete!';
                setTimeout(() => {
                    statusDiv.textContent = '';
                }, 3000);
            }, 1000);
        }
        
        // Upload classifications
        function uploadClassifications(event) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.textContent = 'Uploading...';
            
            const file = event.target.files[0];
            if (!file) {
                statusDiv.textContent = 'No file selected';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/upload_classifications', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusDiv.textContent = 'Upload successful! Refreshing...';
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    statusDiv.textContent = `Error: ${data.message}`;
                }
            })
            .catch(error => {
                statusDiv.textContent = `Error: ${error.message}`;
            });
            
            // Clear the file input
            event.target.value = '';
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
